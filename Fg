[CmdletBinding()]
param (
    [string]$ConfigFile = "C:\housekeeping_config.xml"
)

# Function to load and parse XML configuration
function Get-Config {
    param (
        [string]$xmlPath
    )

    if (-not (Test-Path $xmlPath)) {
        throw "Configuration file not found: $xmlPath"
    }

    try {
        [xml]$xml = [xml](Get-Content $xmlPath)
        return $xml
    } catch {
        throw "Failed to read or parse the XML file: $_"
    }
}

# Function to log messages
function Log-Message {
    param (
        [string]$message,
        [string]$LogFile = "D:\data\temp\housekeeping_log.txt"
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "$timestamp - $message"
    Add-Content -Path $LogFile -Value $logEntry
}

# Function to apply housekeeping rules
function Apply-Housekeeping {
    param (
        [xml]$config
    )

    try {
        $logFilePath = $config.Housekeeping.LogFile.Path
        Log-Message -message "Applying housekeeping rules from config." -LogFile $logFilePath

        foreach ($rule in $config.Housekeeping.PathRules.PathRule) {
            Log-Message -message "Processing rule for path: $($rule.Path)" -LogFile $logFilePath
            
            # Handle ExcludeFolders
            $excludeFolders = @()
            if ($rule.ExcludeFolders -and $rule.ExcludeFolders.ExcludeFolder) {
                foreach ($folder in $rule.ExcludeFolders.ExcludeFolder) {
                    $excludeFolders += $folder
                }
            }
            Log-Message -message "Exclude Folders: $($excludeFolders -join ', ')" -LogFile $logFilePath

            # Continue with the rest of the housekeeping logic
            Log-Message -message "Rule Details: $(($rule | Out-String).Trim())" -LogFile $logFilePath
        }

        foreach ($memoryDumpRule in $config.Housekeeping.MemoryDumpRules.MemoryDumpRule) {
            Log-Message -message "Processing memory dump rule for path: $($memoryDumpRule.Path)" -LogFile $logFilePath
            # Log the entire memory dump rule to help with debugging
            Log-Message -message "Memory Dump Rule Details: $(($memoryDumpRule | Out-String).Trim())" -LogFile $logFilePath
        }

    } catch {
        Log-Message -message "Error applying housekeeping rules: $_" -LogFile $logFilePath
    }
}

# Main script execution
try {
    $xmlConfig = Get-Config -xmlPath $ConfigFile
    Apply-Housekeeping -config $xmlConfig
} catch {
    Log-Message -message "Script error: $_" -LogFile "D:\data\temp\housekeeping_log.txt"
}
