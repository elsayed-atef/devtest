param (
    [string]$ConfigFile = "D:\data\housekeeping_config.xml",
    [switch]$Parallel,
    [switch]$DryRun
)

# Import the XML configuration
$xmlConfig = [xml](Get-Content $ConfigFile)

# Function to perform cleanup
function Perform-Cleanup {
    param (
        [string]$Path,
        [bool]$IncludeSubfolders,
        [string[]]$ExcludePatterns,
        [int]$RetentionDays,
        [bool]$ArchiveBeforeDelete,
        [string]$ArchivePath,
        [switch]$DryRun
    )

    # Calculate retention date
    $RetentionDate = (Get-Date).AddDays(-$RetentionDays)

    # Get files to delete
    $files = Get-ChildItem -Path $Path -Recurse:$IncludeSubfolders | 
             Where-Object { $_.LastWriteTime -lt $RetentionDate }

    if ($ExcludePatterns) {
        foreach ($pattern in $ExcludePatterns) {
            $files = $files | Where-Object { $_.FullName -notmatch $pattern }
        }
    }

    # DryRun mode
    if ($DryRun) {
        Write-Host "DryRun: The following files would be processed:"
        $files | ForEach-Object { Write-Host $_.FullName }
        return
    }

    # Archive files if required
    if ($ArchiveBeforeDelete -and $ArchivePath) {
        foreach ($file in $files) {
            $dest = Join-Path -Path $ArchivePath -ChildPath $file.FullName.TrimStart($Path)
            $destDir = Split-Path $dest
            if (-not (Test-Path $destDir)) {
                New-Item -Path $destDir -ItemType Directory | Out-Null
            }
            Move-Item -Path $file.FullName -Destination $dest
        }
    }

    # Report before deletion
    $initialSize = ($files | Measure-Object -Property Length -Sum).Sum / 1MB
    Write-Host "Initial size: $([math]::round($initialSize, 2)) MB"

    # Delete files
    $deletedCount = 0
    foreach ($file in $files) {
        Remove-Item -Path $file.FullName -Force
        $deletedCount++
    }

    # Report after deletion
    Write-Host "$deletedCount files deleted."
    $finalSize = (Get-ChildItem -Path $Path -Recurse:$IncludeSubfolders | Measure-Object -Property Length -Sum).Sum / 1MB
    Write-Host "Final size: $([math]::round($finalSize, 2)) MB"
}

# Sort paths to ensure subfolders are processed before parent folders
$sortedPaths = $xmlConfig.Housekeeping.Paths.Path | Sort-Object -Property { $_.Path.Length } -Descending

# Process each path configuration
foreach ($pathConfig in $sortedPaths) {
    $path = $pathConfig.Path
    $enabled = [bool]$pathConfig.Enabled
    $includeSubfolders = [bool]$pathConfig.IncludeSubfolders
    $excludePatterns = $pathConfig.ExcludePatterns.Pattern
    $retentionDays = [int]$pathConfig.RetentionDays
    $archiveBeforeDelete = [bool]$pathConfig.ArchiveBeforeDelete
    $archivePath = $pathConfig.ArchivePath

    if ($enabled) {
        if ($Parallel) {
            Start-Job -ScriptBlock {
                Perform-Cleanup -Path $using:path -IncludeSubfolders $using:includeSubfolders `
                               -ExcludePatterns $using:excludePatterns `
                               -RetentionDays $using:retentionDays `
                               -ArchiveBeforeDelete $using:archiveBeforeDelete `
                               -ArchivePath $using:archivePath `
                               -DryRun:$using:DryRun
            } | Out-Null
        } else {
            Perform-Cleanup -Path $path -IncludeSubfolders $includeSubfolders `
                            -ExcludePatterns $excludePatterns `
                            -RetentionDays $retentionDays `
                            -ArchiveBeforeDelete $archiveBeforeDelete `
                            -ArchivePath $archivePath `
                            -DryRun:$DryRun
        }
    }
}

# Heapdump cleanup
$heapdumpConfig = $xmlConfig.Housekeeping.Heapdump
$heapdumpPath = $heapdumpConfig.Path
$heapdumpRetentionDays = [int]$heapdumpConfig.RetentionDays

if ($heapdumpConfig.Enabled -eq "true") {
    Write-Host "Performing heapdump cleanup..."
    Perform-Cleanup -Path $heapdumpPath -IncludeSubfolders $false `
                    -ExcludePatterns @() `
                    -RetentionDays $heapdumpRetentionDays `
                    -ArchiveBeforeDelete $false `
                    -ArchivePath "" `
                    -DryRun:$DryRun
}

# Wait for all jobs to finish
if ($Parallel) {
    Get-Job | Wait-Job | Receive-Job | Remove-Job
}

Write-Host "Housekeeping completed."
