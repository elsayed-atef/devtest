# Function to Check if Current Time is Within Any Peak Hour Range
function Is-In-PeakHours {
    param (
        [DateTime]$currentTime,
        [array]$timeRanges
    )

    foreach ($range in $timeRanges) {
        $startTime = [datetime]::ParseExact($range.Start, "HH:mm", $null)
        $endTime = [datetime]::ParseExact($range.End, "HH:mm", $null)

        # Handle cases where end time is on the next day
        if ($endTime -lt $startTime) {
            $currentTimeInRange = $currentTime.TimeOfDay -ge $startTime.TimeOfDay -or $currentTime.TimeOfDay -lt $endTime.TimeOfDay
        } else {
            $currentTimeInRange = $currentTime.TimeOfDay -ge $startTime.TimeOfDay -and $currentTime.TimeOfDay -lt $endTime.TimeOfDay
        }

        if ($currentTimeInRange) {
            return $true
        }
    }

    return $false
}

# Peak Hours Configuration
$peakHoursEnabled = Convert-XmlBoolean -xmlValue $config.HousekeepingConfig.Settings.PeakHours.Enabled
$timeRanges = $config.HousekeepingConfig.Settings.PeakHours.TimeRange | ForEach-Object {
    [PSCustomObject]@{
        Start = $_.Start
        End = $_.End
    }
}

if ($peakHoursEnabled) {
    $currentTime = Get-Date
    if (Is-In-PeakHours -currentTime $currentTime -timeRanges $timeRanges) {
        Log-Message -Level "Info" -Message "Current time is within peak hours. Housekeeping script is paused."
        exit
    }
}
