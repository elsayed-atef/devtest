function Is-In-PeakHours {
    param (
        [datetime]$currentTime,
        [array]$timeRanges
    )
    foreach ($range in $timeRanges) {
        $startTime = [datetime]::ParseExact($range.Start, "HH:mm", $null)
        $endTime = [datetime]::ParseExact($range.End, "HH:mm", $null)

        if ($currentTime.TimeOfDay -ge $startTime.TimeOfDay -and $currentTime.TimeOfDay -lt $endTime.TimeOfDay) {
            return $true
        }
    }
    return $false
}

while ($true) {
    $config = [xml](Get-Content "HousekeepingConfig.xml")

    # Check if Peak Hours are Enabled and If the Script Needs to Sleep Until Peak Hours End
    $currentTime = Get-Date
    $peakHoursEnabled = [bool]$config.HousekeepingConfig.Settings.PeakHours.Enabled
    $sleepUntilPeakHoursEnd = [bool]$config.HousekeepingConfig.Settings.PeakHours.SleepUntilEnd
    $timeRanges = $config.HousekeepingConfig.Settings.PeakHours.TimeRange.Range

    if ($peakHoursEnabled -and (Is-In-PeakHours -currentTime $currentTime -timeRanges $timeRanges)) {
        if ($sleepUntilPeakHoursEnd) {
            # Calculate the remaining sleep time until the end of the peak hours
            $endPeakHours = $timeRanges | Where-Object {
                $endTime = [datetime]::ParseExact($_.End, "HH:mm", $null)
                $endTime.TimeOfDay -gt $currentTime.TimeOfDay
            } | Sort-Object Start | Select-Object -First 1

            if ($endPeakHours) {
                $endTimePeak = [datetime]::ParseExact($endPeakHours.End, "HH:mm", $null)
                $sleepTime = ($endTimePeak.TimeOfDay - $currentTime.TimeOfDay).TotalMinutes
                Log-Message -Level "Info" -Message "Sleeping until peak hours end. Sleeping for $sleepTime minutes."
                Start-Sleep -Minutes $sleepTime
            }
        }
    }

    # Perform Housekeeping tasks here

    # Sleep for configured interval
    $cleanupIntervalHours = [int]$config.HousekeepingConfig.Settings.CleanupIntervalHours
    Log-Message -Level "Info" -Message "Sleeping for $cleanupIntervalHours hours."
    Start-Sleep -Seconds ($cleanupIntervalHours * 3600)
}
